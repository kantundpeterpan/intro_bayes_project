---
title: Introduction to Bayesian inference
subtitle: End of course data analysis project
author: ---
execute: 
  warning: false
format:
  pdf:
    papersize: a4
    geometry:
      - margin=3cm
      - top=0.75in
      - bottom=0.75in
    include-in-header: 
      - text: \usepackage{pdflscape}
---


The Center for Disease Control (CDC) reports the vaccination coverage of
Varicella among young children. Varicella, commonly known as chicken-
pox, is a highly contagious viral infection caused by the varicella-zoster virus
(VZV). Vaccination against chickenpox has been highly effective in reducing
the incidence and severity of the disease. In the United States, vaccination
against varicella has been part of the routine childhood immunization sched-
ule since the mid-1990s. Since the vaccine’s introduction, there has been a
dramatic decline in the number of chickenpox cases, hospitalizations, and
deaths associated with the disease. The target for vaccination coverage of
varicella (chickenpox) in the United States, as set by the Centers for Dis-
ease Control and Prevention (CDC), is typically around 90% or higher for
children. This high coverage rate is aimed at achieving herd immunity and
preventing outbreaks of chickenpox within communities.


# Project 1: Insurance
The next table summarizes, based on a survey, the number of children in the
birth cohort 2014-2017 that had at least one dose of the Varicella vaccine. It
gives the number of vaccinated children (Vaccinated) amongst the number
of children in the survey (Sample Size). The information is provided for 5
regions of the US, and split according to insurance status (private insurance, uninsured or any Medicaid).

| Geography | Insurance | Vaccinated | Sample Size |
| :--- | :--- | :--- | :--- |
| North Carolina | Any Medicaid | 380 | 419 |
| North Carolina | Private Insurance Only | 632 | 673 |
| North Carolina | Uninsured | 28 | 34 |
| Georgia | Any Medicaid | 363 | 396 |
| Georgia | Private Insurance Only | 527 | 576 |
| Georgia | Uninsured | 36 | 50 |
| Wisconsin | Any Medicaid | 282 | 332 |
| Wisconsin | Private Insurance Only | 514 | 548 |
| Wisconsin | Uninsured | 16 | 34 |
| Florida | Any Medicaid | 446 | 490 |
| Florida | Private Insurance Only | 588 | 628 |
| Florida | Uninsured | 28 | 39 |
| Mississippi | Private Insurance Only | 400 | 441 |
| Mississippi | Uninsured | 27 | 32 |

# Question 1

::: {.callout}
Derive analytically the posterior of the vaccination coverage per ge-
ography and insurance group. Use a conjugate prior that (1) reflects
no knowledge on the vaccination coverage, and (2) reflects that vac-
cination coverage is typically around 90% or higher. Give posterior
summary measures of the vaccination coverage per geography and in-
surance group. Is the choice of the prior impacting your results?
:::

## Theoretical considerations

The outcome *Vaccinated/Not Vaccinated* follows a Bernouilli distribution with parameter $p$:

$V:$ Vaccination status
$V \in \{0,1\}$
$V \sim \mathcal{Bern}(p)$


It is known from theory that the sum of $n$ $i.i.d$ Bernoulli random variables follows a Binomial distribution. This will be used to model the sample outcome: the number of vaccinated people $V_s$ in a random sample of size $n$:

$$V_s = \sum_i^n V_i \sim \mathcal{Binom}(n, \theta)$$

where $\theta$ is the parameter of interest - the vaccine coverage.

In the course, we saw that the Beta distribution is the conjugate prior for binomially distributed data:

| Distribution | Formula |
| :----------- | :------- |
| Prior | $p(\theta) = \mathcal{Beta}(\alpha, \beta)$ |
| Likelihood | $p(y \mid \theta) = {n \choose k} \theta^k (1 - \theta)^{n-k}$ |
| Posterior | $p(\theta \mid y) = \mathcal{Beta}(\alpha + k, \beta + n - k)$ |

The summary measures for the Beta distribution are defined as follows:

| Summary Measure | Formula |
| :--------------- | :------- |
| Mean  | $\frac{\alpha}{\alpha + \beta}$ |
| Median |  See Note |
| Mode  | $\frac{\alpha - 1}{\alpha + \beta - 2}$ for $\alpha, \beta > 1$ |

Note: The median of the Beta distribution does not have a simple closed form expression. It can be approximated numerically or using statistical software.

```{r echo=F}
knitr::opts_chunk$set(echo = FALSE)
source("./code.R")
```

## Choice of prior distributions

### (1) No prior knowledge
In order to reflect no prior knowledge on the vaccine coverage, the weakly-informative prior Beta(1,1) will be used,  which is equivalent to the uniform distribution over $[0,1]$.

### (2) Vaccine coverage >90%

For modeling prior knowledge that vaccine coverage is about 90%, we chose the Beta(150, 7) distribution. 


### Comparison of priors

```{r}
plot_priors
```

## Results

\begin{landscape}
\small
\centering
```{r echo=F, output='asis'}
post_summary %>% knitr::kable(
    caption = "Posterior distribution parameters and summary measures per geography for the two different Beta priors",
    col.names = c(
        "Geography", "Insurance",
        "alpha", "beta", "mean", "mode", "var", "HPD LL", "HPD UL",
        "alpha", "beta", "mean", "mode", "var", "HPD LL", "HPD UL"
    ),
    digits = 3, linesep = '', format = 'latex')  %>%
  add_header_above(header = c(
    " "=2, "Beta(1,1) prior"=7, "Beta(150,7) prior"=7
  )) %>%
  add_header_above(header = c(
    " "=2, "Posterior parameters and summary measures"=14
  ))
```

\end{landscape}

```{r fig.height=16, fig.width=10}
grid.arrange(grobs = plots)
```


# Question 2

::: {.callout}
nvestigate whether the vaccination coverage is associated with the in-
surance status using a logistic regression model
Yij ∼Binom(πij ,Nij )
with
logit(πij ) = α0 + α1IAnyMedicaid,ij + α2IUninsured,ij
where i is the location, j is the insurance status, πij is the vaccination
coverage and I. are dummy variables. Assume non-informative priors
for the parameters to be estimated. Write and explain the code in
BUGS language
:::
<!-- 
https://github.com/andrewcparnell/jags_examples/blob/master/R%20Code/jags_logistic_regression.R
 -->

```{bugs class.source="numberLines", echo=T}
model
{
  for (t in 1:T) {
    # Likelihood
    y[t] ~ dbin(p[t], K[t])
    # conditional mean model using link function
    logit(p[t]) <- alpha_0 + ins_1 * x_1[t] + ins_2 * x_2[t]
 }

  # Priors
  alpha_0 ~ dnorm(0.0,0.01)
  ins_1 ~ dnorm(0.0,0.01)
  ins_2 ~ dnorm(0.0,0.01)


  # Vaccine coverage per Insurance group
  pi_private <- exp(alpha_0)/(1+exp(alpha_0))
  pi_medicaid <- exp(alpha_0 + ins_1)/(1+exp(alpha_0 + ins_1))
  pi_uninsured <- exp(alpha_0 + ins_2)/(1+exp(alpha_0 + ins_2))

  # Difference between vaccine coverage per insurance group
  diff_priv_medicaid  <- pi_private - pi_medicaid
  diff_priv_uninsured <- pi_private - pi_uninsured
}
```

**Likelihood function and model specification**

For each row `t` in the dataset, the outcome `y[t]` (number of vaccinated children in the sample) is specified as drawn from a Binomial distribution with parameters `p[t]` and sample size `K[t]`. We also specify the conditional mean model for this likelihood function using the `logit` link function.

**Prior distribution**

As prior distribution for all parameters (intercept and indicator variables for the insurance group), a vague prior is chosen : $\mathcal{N}(\mu = 0, \tau = 0.01)$.

**Quantities of interest**
During each MCMC run, the vaccine coverage per insurance group is calculated using the inverse logit transformation, this will give access to the posterior distribution of vaccine coverage per insurance group.
Furthermore, the differences between vaccine coverages are calculated which will be needed to answer Question 6.

# Question 3

::: {.callout}
Run the MCMC method and check convergence of the MCMC chains.
Give the details on how you checked convergence.
:::

## MCMC run summary

```{r}
model_run
```

## Convergence checks

**Traceplots**
```{r}
# par(mfrow=c(1,3))
# plot(mcmc[,c("pi_private", "pi_medicaid", "pi_uninsured")], trace = T, density = F)
mcmc_trace(mcmc[,alpha_params])
```


**Density plots per chain**

```{r}
ggplot(alpha_plot_df, aes(x = value, color = factor(chain))) +
  geom_density() +
  labs(x = "Parameter Value", y = "Density",
       title = "Posterior Density by Parameter and Chain",
       color = "Chain") +
  facet_wrap(~ parameter, scales = "free") + # Use facet_wrap on the 'parameter' column
  theme_minimal()
```

**Autocorrelation plot**


```{r}
mcmc_acf(mcmc[,alpha_params])
```

<!-- **Crosscorrelation plot**
https://www.perplexity.ai/search/in-bayesian-logistic-regressio-jNkQAEmfT1C9dxnasQkB_A 
-->

**$\hat R$**

```{r echo=F}
gelman.diag(mcmc[,alpha_params])
# gelman.plot(mcmc[,alpha_params])
# par(mfrow=c(1,3))
# gelman.plot(mcmc[,alpha_params[1]])
# gelman.plot(mcmc[,alpha_params[2]])
# gelman.plot(mcmc[,alpha_params[3]])
```

**Geweke diagnostics**

```{r}
geweke.diag(mcmc[,alpha_params])
# par(mfrow=c(2,3))
# geweke.plot(mcmc[,alpha_params[1]])
# geweke.plot(mcmc[,alpha_params[2]])
# geweke.plot(mcmc[,alpha_params[3]])
```

# Question 4

::: {.callout}
Make a plot of the posterior of the model parameters and give posterior summary measures. Interpret the results.
:::

```{r fig-alpha-dens, fig.height=3}
ggplot(alpha_plot_df, aes(x = value)) +
  geom_density() +
  labs(x = "Parameter Value", y = "Density",
       title = "Posterior Density by Parameter") +
  facet_wrap(~ parameter, scales = "free") + # Use facet_wrap on the 'parameter' column
  theme_minimal()
```

```{r tbl-alpha-post}
knitr::kable(alpha_summary) %>%
  add_header_above(
    header = c("Parameter"=1, "Summary measures"=3, "95% HPD interval"=2)
  )
```


Plots of posterior densities and summary measures of the model parameters are given in @fig-alpha-dens and @tbl-alpha-post, respectively.

With `Private Insurance Only` as reference category the interpretation of the parameters is as follows:

- $\alpha_0$ gives the $log(odds)$ of Vaccinated *vs.* Non-Vaccinated in the private insurance group
- $\alpha_1$ gives the change in $log(odds)$ in the Medicaid group *vs.* the private Insurance group, the $log(odds)$ in the Medicaid group are given by $\alpha_0 + \alpha_1$
- $\alpha_2$ gives the change in $log(odds)$ in the Uninsured group *vs.* the private Insurance group, the $log(odds)$ in the Uninsured group are given by $\alpha_0 + \alpha_2$

Numerically, the posterior mean of $\alpha_0$ is estimated at `r alpha_summary[1,1]`  and with a posterior probability of 95% $\alpha_0$ lies in $[`r alpha_summary$LL[1]`,`r alpha_summary$UL[1]`]$.
The posterior estimates for $\alpha_1$ and $\alpha_2$ can be read in the same manner from @tbl-alpha-post.

# Question 5

::: {.callout}
Give the posterior estimate of the vaccination coverage per region and insurance status. Compare with the analytical results you obtained in Question 1.
:::

The vaccine coverage in a given group can be obtained from the $log(odds)$ (see model code Question 3): 

$$\pi = {\exp(log(odds)) \over 1+\exp(log(odds))}$$

Posterior estimates for the mean vaccine coverage per region and insurance status are given in @tbl-q5-post and @fig-q5-comp.

```{r tbl-q5-post, output='asis'}
# cols <- colnames(q5)
# cols[8] = "$\\Delta_{Beta(150,7)}$"

knitr::kable(
    q5,
    digits = 3,
    # format = 'latex',
    booktabs = T,
    caption = 'Posterior estimates of mean vaccine coverages from the logistic regression model vs. estimates from conjugate pair modeling. Subscripts indicate whether the esimates was obtained from logistic regression or the chosen prior distribution, respectively. $\\Delta_{Beta(\\alpha, \\beta)}$ gives the difference between posterior estimates from the logistic regression model and conjugate pair modeling. Vaccine coverage for MS/Medicaid can only be obtained from the logistic regression model.'
  )
```

```{r fig-q5-comp, fig.cap=fig_q5_comp_cap}
# grid.arrange(grobs = list(q5_compbeta11_plot, q5_compbetaconf_plot), ncol = 2)
q5_compplot + ylab(TeX("$\\bar\\pi_{logreg} - \\bar\\pi_{\\Beta(\\alpha, \\beta)}$"))
```

# Question 6

::: {.callout}
Based on the logistic regression model, what is the probability (a posteriori) that coverage amongst children that have private insurance is higher than amongst children that have any medicaid? And compared to children with no insurance?
:::

To answer this question, the differences $\pi_{private} - \pi_{medicaid}$ and $\pi_{private} - \pi_{uninsured}$ were incorporated and observed during the MCMC run of the model specified in Question 3. Posterior densities and empirical CDF are shown in @fig-q6-diff.

```{r fig-q6-diff}
diff_dens_plot
```

The probabilities of interest defined below and can be approximated by using the posterior samples from the MCMC runs :

1. $P(\pi_{priv} > \pi_{medicaid}) = P(\pi_{priv} - \pi_{medicaid} > 0) = `r round(p_priv_greater_medicaid, 5)`$
2. $P(\pi_{priv} > \pi_{uninsured}) = P(\pi_{priv} - \pi_{uninsured} > 0) = `r round(p_priv_greater_uninsured, 3)`$

# Question 7

::: {.callout}
Secondly, investigate whether the vaccination coverages are distinct at the different locations by adding a location-specific intercept.

$$
\operatorname{logit}\left(\pi_{i j}\right)=\alpha_{0 i}+\alpha_1 I_{\text {AnyMedicaid }}+\alpha_2 I_{\text {Uninsured }}
$$


Assume non-informative priors for the parameters to be estimated. Write the code in BUGS language. Give a brief summary of the convergence checks you performed. Compare posteriors of vaccination coverages with results from Question 1.
:::

```{r class.output="numberLines", class.results="numberLines", results='markup'}
# cat(sprintf("\`\`\`{class.output = }
#   %s\n
#   \`\`\`
  # ", 
cat(q7_jags_str)
# ))
```

Convergence was checked in a similar way as for the model defined in Question 3. In brief, trace plots showed the expected caterpillar pattern,  posterior densities per parameter and chain showed superposed well and autocorrelation plots revealed decreasing autocorrelation with increasing lag number - all indicating convergence.

```{r tbl-q7-post, output='asis'}
# cols <- colnames(q5)
# cols[8] = "$\\Delta_{Beta(150,7)}$"

knitr::kable(
    q7,
    digits = 3,
    # format = 'latex',
    booktabs = T,
    caption = 'Posterior estimates of mean vaccine coverages from the logistic regression model including a region specific intercept vs. estimates from conjugate pair modeling. Subscripts indicate whether the esimates was obtained from logistic regression or the chosen prior distribution, respectively. $\\Delta_{Beta(\\alpha, \\beta)}$ gives the difference between posterior estimates from the logistic regression model and conjugate pair modeling. Vaccine coverage for MS/Medicaid can only be obtained from the logistic regression model.'
  )
```

```{r fig-q7-comp}
# grid.arrange(grobs = list(q5_compbeta11_plot, q5_compbetaconf_plot), ncol = 2)
q7_compplot + ylab(TeX("$\\bar\\pi_{logreg} - \\bar\\pi_{\\Beta(\\alpha, \\beta)}$"))
```

# Question 8

::: {.callout}
Compare the vaccination coverage in each of the location with the vaccination coverage in North Carolina:

$$
\theta_{i j}=\frac{\pi_{i j}}{\pi_{\text {North Carolina }, j}}
$$


Interpret the results.
:::

```{r}
knitr::kable(q8_hpddf)
```

```{r}
ridge_plot
```

# Question 9

::: {.callout}
Make a caterpillar plot of the estimated coverage (per location and insurance status). Include also the observed vaccination proportion in the plot.
:::

# Question 10

::: {.callout}
No data is given for children insured by Any medicaid in Mississippi.
Predict the number of vaccinated individuals in Mississippi among 519
children with any medicaid
:::